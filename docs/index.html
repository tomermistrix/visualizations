<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Compression Comparison</title>
    <link rel="stylesheet" href="https://unpkg.com/beerslider/dist/BeerSlider.css">
    <style>
        body {
            font-family: sans-serif;
            background: #f6f8fa;
            max-width: 960px;
            margin: 20px auto;
            padding: 0 15px;
        }
        .comparison-container {
            background: #fff;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }
        .comparison-row {
            display: flex;
            gap: 20px;
        }
        .slider-box, .canvas-box {
            flex: 1;
        }
        .canvas-box canvas {
            width: 100%;
            height: auto;
            border: 1px solid #ccc;
            display: block;
        }
        .beer-slider video, .beer-reveal video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .beer-handle {
            font-size: 0;
        }
        .controls-panel {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding: 10px;
            background-color: #f1f1f1;
            border-radius: 4px;
        }
        .video-select-btn {
            padding: 6px 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
            margin: 0 2px;
        }
        .video-select-btn.active {
            background-color: #0366d6;
            color: white;
            border-color: #0366d6;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Video Compression Comparison</h1>
    <div id="comparisons-root"></div>
    <script src="https://unpkg.com/beerslider/dist/BeerSlider.js"></script>
    <script>
    const videoData = [
        {
            index: 0,
            title: "Sheep",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
        {
            index: 1,
            title: "Drop of Water",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
        {
            index: 2,
            title: "Model",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
        {
            index: 3,
            title: "Clay",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
        {
            index: 4,
            title: "River",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
        {
            index: 5,
            title: "Model",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
        {
            index: 6,
            title: "Rain",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
        {
            index: 7,
            title: "Interview",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
        // {
        //     index: 8,
        //     title: "Interview",
        //     sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
        //     defaultLeft: 'Ours',
        //     defaultRight: 'H.264'
        // }
    ];

    const VIDEO_BASE_PATH = 'assets/videos/';

    document.addEventListener('DOMContentLoaded', () => {
        const root = document.getElementById('comparisons-root');

        videoData.forEach(set => {
            const videoSetBasePath = `${VIDEO_BASE_PATH}${set.index}/`;

            const comparisonBlock = document.createElement('div');
            comparisonBlock.className = 'comparison-container';

            const row = document.createElement('div');
            row.className = 'comparison-row';

            const sliderBox = document.createElement('div');
            sliderBox.className = 'slider-box';
            sliderBox.innerHTML = `
                <div id="slider-${set.index}" class="beer-slider" data-beer-label="${set.defaultLeft}">
                    <video id="video-left-${set.index}" loop muted autoplay playsinline>
                        <source src="${videoSetBasePath}${set.sources[set.defaultLeft]}" type="video/mp4">
                    </video>
                    <div class="beer-reveal" data-beer-label="${set.defaultRight}">
                        <video id="video-right-${set.index}" loop muted autoplay playsinline>
                            <source src="${videoSetBasePath}${set.sources[set.defaultRight]}" type="video/mp4">
                        </video>
                    </div>
                </div>
            `;

            const canvasBox = document.createElement('div');
            canvasBox.className = 'canvas-box';
            const canvas = document.createElement('canvas');
            canvas.id = `canvas-${set.index}`;
            canvasBox.appendChild(canvas);

            row.appendChild(sliderBox);
            row.appendChild(canvasBox);
            comparisonBlock.appendChild(row);
            root.appendChild(comparisonBlock);

            const leftVideo = document.getElementById(`video-left-${set.index}`);
            const rightVideo = document.getElementById(`video-right-${set.index}`);
            const sliderElement = document.getElementById(`slider-${set.index}`);

            let videosReady = 0;
            const onVideoReady = () => {
                if (++videosReady === 2) {
                    new BeerSlider(sliderElement);
                    syncVideos(leftVideo, rightVideo);
                }
            };

            leftVideo.addEventListener('loadedmetadata', onVideoReady);
            rightVideo.addEventListener('loadedmetadata', onVideoReady);

            // Generate canvas preview with bbox
            if (set.bbox && set.frameIdx !== undefined) {
                const [x, y, w, h] = set.bbox;
                const ctx = canvas.getContext('2d');
                const hiddenVideo = document.createElement('video');
                hiddenVideo.src = `${videoSetBasePath}${set.sources['Original']}`;
                hiddenVideo.crossOrigin = 'anonymous';
                hiddenVideo.style.display = 'none';
                hiddenVideo.muted = true;
                document.body.appendChild(hiddenVideo);

                hiddenVideo.addEventListener('loadedmetadata', () => {
                    hiddenVideo.currentTime = set.frameIdx / 30; // assume 30fps
                });

                hiddenVideo.addEventListener('seeked', () => {
                    const vw = hiddenVideo.videoWidth;
                    const vh = hiddenVideo.videoHeight;
                    canvas.width = vw;
                    canvas.height = vh;
                    ctx.drawImage(hiddenVideo, 0, 0, vw, vh);
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, w, h);
                });

                hiddenVideo.load();
            }
        });
    });

    function syncVideos(master, slave) {
        ['play', 'pause', 'seeking'].forEach(event => {
            master.addEventListener(event, () => {
                if(event === 'play' && slave.paused) slave.play();
                if(event === 'pause' && !slave.paused) slave.pause();
                if(event === 'seeking') slave.currentTime = master.currentTime;
            });
        });
        master.addEventListener('timeupdate', () => {
            if (Math.abs(master.currentTime - slave.currentTime) > 0.1) {
                slave.currentTime = master.currentTime;
            }
        });
    }
    </script>
</body>
</html>
