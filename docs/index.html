<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Compression Comparison</title>
    <link rel="stylesheet" href="https://unpkg.com/beerslider/dist/BeerSlider.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 960px;
            margin: 20px auto;
            padding: 0 15px;
            background-color: #f6f8fa;
        }
        h1, h2, h3 {
            border-bottom: 1px solid #eaecef;
            padding-bottom: .3em;
        }
        .comparison-container {
            background: #fff;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }
        /* NEW: Styles for the two-row structure */
        .top-row, .bottom-row {
            display: flex;
            gap: 20px;
        }
        .bottom-row {
            margin-top: 10px; /* Space between slider and controls */
        }
        .top-row > div, .bottom-row > div {
            flex: 1; /* Make columns in each row equal width */
        }
        .canvas-box canvas {
            width: 100%;
            height: 100%; /* This now works because the parent is stretched to the correct height */
            border: 1px solid #ccc;
            display: block;
            object-fit: cover; /* Ensures the drawn image covers the canvas area */
        }
        .beer-slider video, .beer-reveal video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .beer-handle {
            font-size: 0;
        }
        .controls-panel {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #f1f1f1;
            border-radius: 4px;
        }
        .video-select-btn {
            padding: 6px 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
            margin: 0 2px;
        }
        .video-select-btn.active {
            background-color: #0366d6;
            color: white;
            border-color: #0366d6;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Video Compression Comparison</h1>
    <div id="comparisons-root"></div>
    <script src="https://unpkg.com/beerslider/dist/BeerSlider.js"></script>
    <script>
    const videoData = [
        {
            index: 0,
            title: "Sheep",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
        {
            index: 1,
            title: "Drop of Water",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
        {
            index: 2,
            title: "Model",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
        {
            index: 3,
            title: "Clay",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
        {
            index: 4,
            title: "River",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
        {
            index: 5,
            title: "Model",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
        {
            index: 6,
            title: "Rain",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
        {
            index: 7,
            title: "Interview",
            sources: { 'Original': 'original.mp4', 'Ours': 'ours.mp4', 'H.264': 'h264.mp4', 'H.265': 'h265.mp4' },
            defaultLeft: 'Ours',
            defaultRight: 'H.264',
            frameIdx: 10,
            bbox: [0, 0, 100, 100]
        },
    ];

    const VIDEO_BASE_PATH = 'assets/videos/';

    document.addEventListener('DOMContentLoaded', () => {
        const root = document.getElementById('comparisons-root');

        videoData.forEach(set => {
            const videoSetBasePath = `${VIDEO_BASE_PATH}${set.index}/`;

            // --- Start building elements for the new layout ---

            const comparisonBlock = document.createElement('div');
            comparisonBlock.className = 'comparison-container';
            comparisonBlock.innerHTML = `<h2>${set.title}</h2>`;

            // ROW 1: Slider and Canvas
            const topRow = document.createElement('div');
            topRow.className = 'top-row';
            
            const sliderElement = document.createElement('div');
            sliderElement.id = `slider-${set.index}`;
            sliderElement.className = 'beer-slider';
            sliderElement.dataset.beerLabel = set.defaultLeft;
            sliderElement.innerHTML = `
                <video id="video-left-${set.index}" loop muted autoplay playsinline>
                    <source src="${videoSetBasePath}${set.sources[set.defaultLeft]}" type="video/mp4">
                </video>
                <div class="beer-reveal" data-beer-label="${set.defaultRight}">
                    <video id="video-right-${set.index}" loop muted autoplay playsinline>
                        <source src="${videoSetBasePath}${set.sources[set.defaultRight]}" type="video/mp4">
                    </video>
                </div>
            `;
            
            const canvasBox = document.createElement('div');
            canvasBox.className = 'canvas-box';
            const canvas = document.createElement('canvas');
            canvas.id = `canvas-${set.index}`;
            canvasBox.appendChild(canvas);

            topRow.appendChild(sliderElement);
            topRow.appendChild(canvasBox);
            
            // ROW 2: Controls and Empty Placeholder
            const bottomRow = document.createElement('div');
            bottomRow.className = 'bottom-row';

            let leftButtonsHTML = '';
            let rightButtonsHTML = '';
            Object.keys(set.sources).forEach(key => {
                const rightActiveClass = key === set.defaultRight ? 'active' : '';
                rightButtonsHTML += `<button class="video-select-btn ${rightActiveClass}" data-slider-index="${set.index}" data-side="right" data-source-key="${key}">${key}</button>`;
                
                const leftActiveClass = key === set.defaultLeft ? 'active' : '';
                leftButtonsHTML += `<button class="video-select-btn ${leftActiveClass}" data-slider-index="${set.index}" data-side="left" data-source-key="${key}">${key}</button>`;
            });

            const controlsPanel = document.createElement('div');
            controlsPanel.className = 'controls-panel';
            controlsPanel.innerHTML = `
                <div class="left-controls">
                    <h3>Left Video</h3>
                    ${leftButtonsHTML}
                </div>
                <div class="right-controls">
                    <h3>Right Video</h3>
                    ${rightButtonsHTML}
                </div>
            `;

            const emptyCell = document.createElement('div'); // The empty placeholder

            bottomRow.appendChild(controlsPanel);
            bottomRow.appendChild(emptyCell);

            // Append rows to the main container
            comparisonBlock.appendChild(topRow);
            comparisonBlock.appendChild(bottomRow);

            root.appendChild(comparisonBlock);

            // --- Original logic for initialization and events ---
            
            const leftVideo = document.getElementById(`video-left-${set.index}`);
            const rightVideo = document.getElementById(`video-right-${set.index}`);

            let videosReady = 0;
            const onVideoReady = () => {
                if (++videosReady === 2) {
                    new BeerSlider(sliderElement);
                    syncVideos(`video-left-${set.index}`, `video-right-${set.index}`);
                }
            };

            leftVideo.addEventListener('loadedmetadata', onVideoReady);
            rightVideo.addEventListener('loadedmetadata', onVideoReady);

            if (set.bbox && set.frameIdx !== undefined) {
                const [x, y, w, h] = set.bbox;
                const ctx = canvas.getContext('2d');
                const hiddenVideo = document.createElement('video');
                hiddenVideo.src = `${videoSetBasePath}${set.sources['Original']}`;
                hiddenVideo.crossOrigin = 'anonymous';
                hiddenVideo.style.display = 'none';
                hiddenVideo.muted = true;
                document.body.appendChild(hiddenVideo);

                hiddenVideo.addEventListener('loadedmetadata', () => {
                    hiddenVideo.currentTime = set.frameIdx / 30; // assume 30fps
                });

                hiddenVideo.addEventListener('seeked', () => {
                    const vw = hiddenVideo.videoWidth;
                    const vh = hiddenVideo.videoHeight;
                    canvas.width = vw;
                    canvas.height = vh;
                    ctx.drawImage(hiddenVideo, 0, 0, vw, vh);
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, w, h);
                    document.body.removeChild(hiddenVideo);
                });

                hiddenVideo.load();
            }
        });
        root.addEventListener('click', handleSourceChange);
    });

    function syncVideos(masterId, slaveId) {
        const master = document.getElementById(masterId);
        const slave = document.getElementById(slaveId);
        if (!master || !slave) return;

        ['play', 'pause', 'seeking'].forEach(event => {
            master.addEventListener(event, () => {
                if(event === 'play' && slave.paused) slave.play();
                if(event === 'pause' && !slave.paused) slave.pause();
                if(event === 'seeking') slave.currentTime = master.currentTime;
            });
        });

        master.addEventListener('timeupdate', () => {
            if (Math.abs(master.currentTime - slave.currentTime) > 0.1) {
                slave.currentTime = master.currentTime;
            }
        });
    }

    function handleSourceChange(event) {
        if (!event.target.matches('.video-select-btn')) return;

        const button = event.target;
        const { sliderIndex, side, sourceKey } = button.dataset;

        const videoId = `video-${side}-${sliderIndex}`;
        const videoEl = document.getElementById(videoId);
        if (!videoEl) return;

        const setConfig = videoData.find(s => s.index == sliderIndex);
        const newSrc = `${VIDEO_BASE_PATH}${sliderIndex}/${setConfig.sources[sourceKey]}`;

        const otherSide = side === 'left' ? 'right' : 'left';
        const otherVideoEl = document.getElementById(`video-${otherSide}-${sliderIndex}`);

        const sliderEl = document.getElementById(`slider-${sliderIndex}`);
        const revealEl = sliderEl.querySelector('.beer-reveal');
        
        if (side === 'left') {
            sliderEl.dataset.beerLabel = sourceKey;
        } else {
            revealEl.dataset.beerLabel = sourceKey;
        }

        videoEl.querySelector('source').setAttribute('src', newSrc);
        videoEl.load();
        
        const playPromise = videoEl.play();
        if (playPromise !== undefined) {
            playPromise.then(() => {
                otherVideoEl.play();
            }).catch(error => {
                console.error("Autoplay was prevented:", error);
            });
        }

        button.parentElement.querySelectorAll('.video-select-btn').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
    }
    </script>
</body>
</html>